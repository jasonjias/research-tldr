<!DOCTYPE html>
<html>

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ GA_MEASUREMENT_ID }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', '{{ GA_MEASUREMENT_ID }}');
    </script>

    <title>arXiv Papers</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    RR: "\\mathbb{R}",
                    VV: "\\mathbb{V}",
                    VVV: "\\mathcal{V}",
                    ZZ: "\\mathbb{Z}"
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    <style>
        /* ========= Theme tokens ========= */
        :root {
            --gap-xxs: 4px;
            --gap-xs: 6px;
            --pad-x: 12px;
            --icon: 20px;

            --c-text: #111;
            --c-muted: #ddd;
            --c-border: #d1d5db;
            --c-bg-btn: #f8fafc;
            --c-bg-btn-hover: #eef2f7;
            --c-bookmark: #ff6b6b;
            --c-focus: #fff1e1;
            /* focused paper background */
        }

        /* ========= Small utilities (optional to reuse) ========= */
        .u-icon-btn {
            appearance: none;
            border: 0;
            background: transparent;
            cursor: pointer;
            padding: var(--gap-xs);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .u-focus-ring {
            outline: 2px solid var(--c-muted);
            outline-offset: 2px;
            border-radius: 4px;
        }

        .u-icon {
            width: var(--icon);
            height: var(--icon);
            display: block;
        }

        .u-btn {
            appearance: none;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            color: var(--c-text);
            border: 1px solid var(--c-border);
            background: var(--c-bg-btn);
            padding: 6px 10px;
        }

        /* ========= Your original selectors (preserved) ========= */

        /* Bookmark button */
        .bookmark-toggle {
            appearance: none;
            background: transparent;
            border: 0;
            cursor: pointer;
            padding: 6px 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .bookmark-toggle:focus {
            outline: 2px solid var(--c-muted);
            outline-offset: 2px;
            border-radius: 4px;
        }

        .bookmark-toggle:hover .bm-shape {
            opacity: .85;
        }

        .bm-icon {
            display: block;
            width: var(--icon);
            height: var(--icon);
        }

        .bm-shape {
            fill: none;
            paint-order: stroke fill markers;
            vector-effect: non-scaling-stroke;
            transition: fill 120ms ease;
        }

        .bookmark-toggle[aria-pressed="true"] .bm-shape {
            fill: var(--c-bookmark);
        }

        /* Eye/visibility button */
        .visibility-toggle {
            appearance: none;
            border: 0;
            background: transparent;
            cursor: pointer;
            padding: 6px 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .visibility-toggle:focus {
            outline: 2px solid var(--c-muted);
            outline-offset: 2px;
            border-radius: 4px;
        }

        .vis-icon {
            width: var(--icon);
            height: var(--icon);
            display: block;
        }

        /* Paper card scaffolding */
        .paper.collapsed .paper-body {
            display: none;
        }

        .paper .title-row {
            display: flex;
            align-items: center;
            gap: var(--gap-xs);
        }

        /* Misc icon container you had */
        .icon-ctl {
            width: var(--icon);
            height: var(--icon);
            display: inline-block;
            vertical-align: middle;
            line-height: 0;
        }

        /* PDF toggle anchor + its svg normalization */
        .rtldr-icon {
            cursor: pointer;
            text-decoration: none;
            padding: var(--gap-xs);
        }

        .rtldr-icon svg {
            width: var(--icon);
            height: var(--icon);
            stroke-width: 1.8;
            display: block;
        }

        /* Focus mode button */
        .rtldr-focus-btn {
            appearance: none;
            border: 1px solid var(--c-border);
            background: var(--c-bg-btn);
            color: var(--c-text);
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .rtldr-focus-btn:hover {
            background: var(--c-bg-btn-hover);
        }

        .rtldr-focus-btn:focus {
            outline: 2px solid var(--c-muted);
            outline-offset: 2px;
        }

        /* Full-bleed highlight for the active paper (keeps your padding/size) */
        .paper.rtldr-focused-paper {
            background: var(--c-focus);
            border-radius: 6px;
            margin-left: calc(-1 * var(--pad-x));
            margin-right: calc(-1 * var(--pad-x));
            padding-left: var(--pad-x);
            padding-right: var(--pad-x);
        }

        /* (Optional) make sure the bookmark inside title row keeps compact spacing */
        .title-row .bookmark-toggle {
            margin: 0;
            padding: 0;
            line-height: 0;
            display: inline-flex;
            align-items: center;
        }

        .title-row .bookmark-toggle svg {
            width: var(--icon);
            height: var(--icon);
        }
    </style>

</head>


<body data-logged-in="{{ '1' if user else '' }}">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
        {% if user %}
        <img src="{{ user.picture }}" referrerpolicy="no-referrer" style="width:28px;height:28px;border-radius:50%">
        <span>Signed in as {{ user.name or user.email }}</span>
        <a href="/logout">Logout</a>
        {% else %}
        <a href="/login">Sign in with Google</a>
        {% endif %}
    </div>
    {% if user %}
    <nav class="view-switcher" style="margin: 12px 0;">
        <a href="/" class="{{ 'font-bold' if active_view != 'bookmarks' else '' }}">All papers</a>
        &nbsp;·&nbsp;
        <a href="/bookmarks" class="{{ 'font-bold' if active_view == 'bookmarks' else '' }}">My bookmarks</a>
    </nav>
    {% endif %}

    <h1>arXiv Papers</h1>
    <!-- Main Category Filters -->
    <div id="category-filters">
        <label for="main-category">Filter by Category:</label>
        <select id="main-category" onchange="filterByMainCategory()">
            <option value="all">All</option>
            <option value="math">Mathematics</option>
            <option value="cs">Computer Science</option>
            <option value="physics">Physics</option>
            <option value="stat">Statistics</option>
            <option value="q-bio">Quantitative Biology</option>
            <option value="q-fin">Quantitative Finance</option>
            <option value="eess">Electrical Engineering & Systems Science</option>
            <option value="econ">Economics</option>
        </select>
    </div>


    <div id="subcategory-filters" style="display: none;">
        <label for="sub-category">Filter by Subcategory:</label>
        <select id="sub-category" onchange="filterBySubCategory()">
            <option value="all">All</option>
        </select>
    </div>
    {% for paper in papers %}
    {% set primary = paper.categories | selectattr("is_primary") | list | first %}
    <div class="paper" data-main="{{ primary.term.split('.')[0] if primary else 'unknown' }}"
        data-sub="{{ paper.categories | map(attribute='term') | join(',') }}">

        <!-- <div style="display: flex; align-items: center; gap: 6px;">
            <h2 style="margin: 0;">{{ paper.title }}</h2>
            <button class="bookmark-toggle" data-paper-id="{{ paper.id }}" aria-pressed="false"
                aria-label="Toggle bookmark" title="Toggle bookmark" type="button">
                <svg class="bm-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                    <path class="bm-shape" d="M6 2h12a2 2 0 0 1 2 2v18l-8-4-8 4V4a2 2 0 0 1 2-2z" fill="none"
                        stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" />
                </svg>
            </button>
        </div> -->

        <div class="title-row" style="display:flex;align-items:center;gap:6px;">
            <!-- bookmark first -->
            <button class="bookmark-toggle" data-paper-id="{{ paper.id }}" aria-pressed="false"
                aria-label="Toggle bookmark" title="Toggle bookmark" type="button">
                <svg class="bm-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                    <path class="bm-shape" d="M6 2h12a2 2 0 0 1 2 2v18l-8-4-8 4V4a2 2 0 0 1 2-2z" fill="none"
                        stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" />
                </svg>
            </button>

            <!-- title next -->
            <h2 style="margin:0;">{{ paper.title }}</h2>

            <!-- the eye button is injected by your JS (stays after the title) -->
        </div>


        <p><strong>Published:</strong> {{ paper.published }}</p>
        <!-- <p><strong>Updated:</strong> {{ paper.updated }}</p> -->
        <p><strong>Authors:</strong> {{ paper.authors }}</p>

        {% if paper.categories %}
        <p><strong>Categories:</strong>
            {% for category in paper.categories %}
            {% if category.is_primary %}
            <span><strong>{{ category.term }}</strong></span>{% if not loop.last %}, {% endif %}
            {% else %}
            <span>{{ category.term }}</span>{% if not loop.last %}, {% endif %}
            {% endif %}
            {% endfor %}
        </p>
        {% endif %}

        <p><strong>Abstract:</strong><br>{{ paper.summary | safe }}</p>

        {% if paper.llm_summary %}
        <details style="margin-top:8px;">
            <summary>
                <strong>Summary</strong>
                ({{ paper.summary_model or 'N/A' }} — added
                {{ paper.summary_updated_at.strftime('%Y-%m-%d %H:%M UTC') if paper.summary_updated_at else 'unknown'
                }})
            </summary>

            <!-- We'll render nicely if llm_summary is JSON; otherwise we show it as-is -->
            <div class="llm-summary" data-json="{{ paper.llm_summary | e }}"
                style="margin-top:6px; white-space:normal;"></div>
            <pre class="llm-summary-fallback" style="white-space:pre-wrap; margin-top:6px; display:none;">
            {{ paper.llm_summary }}
            </pre>
        </details>
        {% endif %}
        <p>
            <a href="{{ paper.url }}">arXiv Page</a> |
            <a href="{{ paper.pdf_url }}">PDF</a>
        </p>
        <!-- inside each paper card row (replace previous meta block) -->
        <div class="meta" data-paper-id="{{ paper.id }}">
            <span class="score">Score: <strong class="score-num">0</strong></span>
            <button class="vote-up" title="Upvote" type="button">▲</button>
            <button class="vote-down" title="Downvote" type="button">▼</button>
        </div>
        <hr>
    </div>
    <!-- <hr> -->
    {% endfor %}

    <script>
        window.addEventListener("load", () => {
            if (window.MathJax) {
                MathJax.typeset();
            }
        });
    </script>
    <script>
        const subcategoryMap = {};

        document.addEventListener("DOMContentLoaded", () => {
            const papers = document.querySelectorAll('.paper');

            // Build subcategory map
            papers.forEach(paper => {
                const main = paper.getAttribute('data-main');
                const subs = paper.getAttribute('data-sub').split(',');

                if (!subcategoryMap[main]) {
                    subcategoryMap[main] = new Set();
                }

                subs.forEach(sub => {
                    if (sub.startsWith(main)) {
                        subcategoryMap[main].add(sub);
                    }
                });
            });
        });

        function filterByMainCategory() {
            const selectedMain = document.getElementById('main-category').value;
            const subFilterDiv = document.getElementById('subcategory-filters');
            const subSelect = document.getElementById('sub-category');

            // Update subcategory dropdown
            if (selectedMain === 'all') {
                subFilterDiv.style.display = 'none';
            } else {
                subFilterDiv.style.display = 'block';
                subSelect.innerHTML = '<option value="all">All</option>';

                const subs = Array.from(subcategoryMap[selectedMain] || []).sort();
                for (const sub of subs) {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subSelect.appendChild(option);
                }
            }

            filterPapers();
        }

        function filterBySubCategory() {
            filterPapers();
        }

        function filterPapers() {
            const selectedMain = document.getElementById('main-category').value;
            const selectedSub = document.getElementById('sub-category').value;
            const papers = document.querySelectorAll('.paper');

            papers.forEach(paper => {
                const main = paper.getAttribute('data-main');
                const subs = paper.getAttribute('data-sub').split(',');

                const matchMain = (selectedMain === 'all' || main === selectedMain);
                const matchSub = (selectedSub === 'all' || subs.includes(selectedSub));

                if (matchMain && matchSub) {
                    paper.style.display = '';
                } else {
                    paper.style.display = 'none';
                }
            });
        }
    </script>
    <script>
        // ---------- GA helper ----------
        function trackEvent(name, params) {
            if (window.gtag) window.gtag('event', name, params || {});
        }

        // After login: fire event and clean URL
        (() => {
            const p = new URLSearchParams(location.search);
            if (p.has('login_success')) {
                trackEvent('login', { method: 'google' });
                history.replaceState(null, '', location.pathname);
            }
        })();
    </script>

    <script>
        // ---------- Paper clicks (arXiv/PDF) ----------
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;

            const url = link.getAttribute('href') || '';
            const isPDF = url.toLowerCase().endsWith('.pdf');
            const isArxiv = /arxiv\.org/.test(url);

            if (isPDF || isArxiv) {
                const paperEl = link.closest('.paper');
                const title = paperEl?.querySelector('h2')?.textContent?.trim();
                // Try to derive an arXiv ID if present in the URL
                const idMatch = url.match(/arxiv\.org\/(?:abs|pdf)\/([^\s\/?#]+)/i);
                const paperId = idMatch ? idMatch[1].replace(/\.pdf$/i, '') : undefined;

                trackEvent('paper_open', {
                    type: isPDF ? 'pdf' : 'arxiv',
                    paper_id: paperId,
                    paper_title: title
                });
            }
        });
    </script>

    <script>
        // ---------- Filter changes ----------
        const mainSelect = document.getElementById('main-category');
        const subSelect = document.getElementById('sub-category');

        if (mainSelect) {
            mainSelect.addEventListener('change', () => {
                trackEvent('filter_change', { filter: 'main_category', value: mainSelect.value });
            });
        }
        if (subSelect) {
            subSelect.addEventListener('change', () => {
                trackEvent('filter_change', {
                    filter: 'sub_category',
                    value: subSelect.value,
                    main_category: mainSelect ? mainSelect.value : undefined
                });
            });
        }
    </script>

    <script>
        // ---------- Paper impressions on load (counts by main category) ----------
        window.addEventListener('load', () => {
            if (window.MathJax?.typesetPromise) MathJax.typesetPromise();
            else if (window.MathJax?.typeset) MathJax.typeset();
        });
    </script>
    <script>
        (function () {
            // Remove leading bullet/numbering like "• ", "- ", "— ", "* ", "1. ", "2) ", etc.
            function cleanItemText(s) {
                if (!s) return "";
                s = String(s);
                // Strip common bullet characters and numeric prefixes
                s = s.replace(/^\s*([•\-\u2013\u2014\*]|\d+[\.\)])\s+/, ""); // • - – — * or 1. / 2)
                // Also collapse accidental double bullets inside the text
                s = s.replace(/^\s*•\s*/, "");
                return s.trim();
            }
            const esc = (t) => String(t || "").replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
            const ul = (arr) => (arr && arr.length)
                ? `<ul style="margin:6px 0 12px 1.25em; list-style:disc; list-style-position:outside;">${arr.map(x => `<li>${esc(cleanItemText(x))}</li>`).join('')
                }</ul>`
                : '';

            function renderSummary(json) {
                let html = "";
                if (json.tldr) {
                    html += `<h4 style="margin:8px 0 4px;">TL;DR</h4><p style="margin:0 0 10px;">${esc(json.tldr)}</p>`;
                }
                if (json.whats_new && json.whats_new.length) {
                    html += `<h4 style="margin:8px 0 4px;">What’s new</h4>${ul(json.whats_new)}`;
                }
                if (json.method) {
                    html += `<h4 style="margin:8px 0 4px;">Method (plain English)</h4><p style="margin:0 0 10px;">${esc(json.method)}</p>`;
                }
                if (json.results && json.results.length) {
                    html += `<h4 style="margin:8px 0 4px;">Results</h4>${ul(json.results)}`;
                }
                if (json.limitations && json.limitations.length) {
                    html += `<h4 style="margin:8px 0 4px;">Limitations</h4>${ul(json.limitations)}`;
                }
                if (json.why_useful) {
                    html += `<h4 style="margin:8px 0 4px;">Why it’s useful</h4><p style="margin:0 0 10px;">${esc(json.why_useful)}</p>`;
                }
                const prov = json.provenance || {};
                const bits = [];
                if (prov.code_data_availability) bits.push(`Code/Data: ${esc(prov.code_data_availability)}`);
                if (Array.isArray(prov.page_citations) && prov.page_citations.length) {
                    bits.push(`Citations: ${esc(prov.page_citations.join(', '))}`);
                }
                if (bits.length) html += `<div style="margin-top:8px; font-size:0.95em; opacity:0.85;">${bits.join(' • ')}</div>`;
                return html || null;
            }

            document.querySelectorAll('.llm-summary').forEach(node => {
                const raw = node.getAttribute('data-json') || '';
                if (!raw.trim().startsWith('{')) {
                    node.style.display = 'none';
                    const pre = node.parentElement.querySelector('.llm-summary-fallback');
                    if (pre) pre.style.display = '';
                    return;
                }
                try {
                    const json = JSON.parse(raw);
                    const html = renderSummary(json);
                    if (html) {
                        node.innerHTML = html;
                        const pre = node.parentElement.querySelector('.llm-summary-fallback');
                        if (pre) pre.style.display = 'none';
                    } else {
                        node.style.display = 'none';
                        const pre = node.parentElement.querySelector('.llm-summary-fallback');
                        if (pre) pre.style.display = '';
                    }
                } catch {
                    node.style.display = 'none';
                    const pre = node.parentElement.querySelector('.llm-summary-fallback');
                    if (pre) pre.style.display = '';
                }
            });
        })();
    </script>
    <script>
        (function () {
            const loggedIn = !!document.body.dataset.loggedIn;

            async function getJSON(url, opts = {}) {
                const r = await fetch(url, { credentials: 'same-origin', ...opts });
                const text = await r.text();
                let data;
                try { data = text ? JSON.parse(text) : null; } catch { data = { detail: text }; }
                if (!r.ok) {
                    const err = new Error((data && (data.detail || data.message)) || 'Request failed');
                    err.status = r.status; err.body = data; throw err;
                }
                return data;
            }

            async function hydrate() {
                // 1) Scores (unchanged)
                document.querySelectorAll('.meta').forEach(m => {
                    const id = m.dataset.paperId;
                    if (!id) return;
                    getJSON(`/api/papers/${id}/score`)
                        .then(d => {
                            const el = m.querySelector('.score-num');
                            if (el) el.textContent = d.score;
                        })
                        .catch(() => { });
                });

                // 2) Bookmarks: hydrate every toggle anywhere in the card
                const toggles = document.querySelectorAll('button.bookmark-toggle[data-paper-id]');
                // Use a Set so we fetch once per paper id
                const ids = new Set(Array.from(toggles).map(b => b.dataset.paperId));

                for (const id of ids) {
                    const btns = document.querySelectorAll(`.bookmark-toggle[data-paper-id="${id}"]`);
                    if (!loggedIn) {
                        btns.forEach(b => {
                            b.setAttribute('aria-pressed', 'false');
                            b.title = 'Sign in to bookmark';
                            b.setAttribute('aria-label', 'Sign in to bookmark');
                        });
                        continue;
                    }
                    try {
                        const s = await getJSON(`/api/papers/${id}/bookmarks`); // { mine: 0|1 }
                        const on = s.mine === 1;
                        btns.forEach(b => {
                            b.setAttribute('aria-pressed', on ? 'true' : 'false');
                            b.setAttribute('aria-label', on ? 'Remove bookmark' : 'Add bookmark');
                        });
                    } catch { }
                }
            }

            document.addEventListener('click', async (e) => {
                // Votes (still handled via the .meta container)
                const meta = e.target.closest('.meta');
                if (meta && (e.target.closest('.vote-up') || e.target.closest('.vote-down'))) {
                    const id = meta.dataset.paperId;
                    if (!id) return;
                    const currentScoreEl = meta.querySelector('.score-num');
                    const currentVote = meta.dataset.myVote ? parseInt(meta.dataset.myVote) : 0;
                    let newValue = 0;
                    if (e.target.closest('.vote-up')) newValue = currentVote === 1 ? 0 : 1;
                    else newValue = currentVote === -1 ? 0 : -1;

                    try {
                        const d = await getJSON(`/api/papers/${id}/vote`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: newValue }),
                        });
                        if (currentScoreEl) currentScoreEl.textContent = d.score;
                        meta.dataset.myVote = newValue;
                    } catch {
                        if (confirm('Please sign in to vote. Go to login?')) location.href = '/login';
                    }
                    return;
                }

                // Bookmarks (works for icon by title OR in meta)
                const btn = e.target.closest('.bookmark-toggle');
                if (btn) {
                    const id = btn.dataset.paperId;
                    if (!id) return;
                    if (!loggedIn) { location.href = '/login'; return; }

                    if (btn.dataset.loading === '1') return; // click lock
                    btn.dataset.loading = '1';
                    btn.disabled = true;

                    const isOn = btn.getAttribute('aria-pressed') === 'true';
                    try {
                        await getJSON(`/api/papers/${id}/bookmark`, { method: isOn ? 'DELETE' : 'POST' });
                        const s = await getJSON(`/api/papers/${id}/bookmarks`); // { mine }
                        const on = s.mine === 1;

                        // Sync all bookmark icons for this paper id
                        document.querySelectorAll(`.bookmark-toggle[data-paper-id="${id}"]`).forEach(b => {
                            b.setAttribute('aria-pressed', on ? 'true' : 'false');
                            b.setAttribute('aria-label', on ? 'Remove bookmark' : 'Add bookmark');
                        });
                    } catch {
                        if (confirm('Please sign in to bookmark papers. Go to login?')) location.href = '/login';
                    } finally {
                        btn.dataset.loading = '0';
                        btn.disabled = false;
                    }
                }
            });

            window.addEventListener('load', hydrate);
        })();
    </script>
    <script>
        const LS_KEYS = {
            MAIN: 'rtldr.mainCategory',
            SUB: 'rtldr.subCategory',
        };

        document.addEventListener("DOMContentLoaded", () => {
            const papers = document.querySelectorAll('.paper');

            // Build subcategory map
            papers.forEach(paper => {
                const main = paper.getAttribute('data-main');
                const subs = paper.getAttribute('data-sub').split(',');

                if (!subcategoryMap[main]) subcategoryMap[main] = new Set();
                subs.forEach(sub => { if (sub.startsWith(main)) subcategoryMap[main].add(sub); });
            });

            // NEW: restore saved category/subcategory
            const mainSel = document.getElementById('main-category');
            const subSel = document.getElementById('sub-category');
            const savedMain = localStorage.getItem(LS_KEYS.MAIN);
            const savedSub = localStorage.getItem(LS_KEYS.SUB);

            if (mainSel && savedMain && [...mainSel.options].some(o => o.value === savedMain)) {
                mainSel.value = savedMain;
                // Ensure subcategory list is rebuilt before applying saved sub
                filterByMainCategory();
                if (subSel && savedSub && [...subSel.options].some(o => o.value === savedSub)) {
                    subSel.value = savedSub;
                }
            }

            // Apply filters on initial load
            filterPapers();
        });

        function filterByMainCategory() {
            const selectedMain = document.getElementById('main-category').value;
            const subFilterDiv = document.getElementById('subcategory-filters');
            const subSelect = document.getElementById('sub-category');

            // Persist (NEW)
            localStorage.setItem(LS_KEYS.MAIN, selectedMain);

            // Update subcategory dropdown
            if (selectedMain === 'all') {
                subFilterDiv.style.display = 'none';
            } else {
                subFilterDiv.style.display = 'block';
                subSelect.innerHTML = '<option value="all">All</option>';
                const subs = Array.from(subcategoryMap[selectedMain] || []).sort();
                for (const sub of subs) {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subSelect.appendChild(option);
                }
            }

            filterPapers();
        }

        function filterBySubCategory() {
            const sub = document.getElementById('sub-category').value;
            // Persist (NEW)
            localStorage.setItem(LS_KEYS.SUB, sub);
            filterPapers();
        }

        function filterPapers() {
            const selectedMain = document.getElementById('main-category').value;
            const selectedSub = document.getElementById('sub-category').value;
            const papers = document.querySelectorAll('.paper');

            papers.forEach(paper => {
                const main = paper.getAttribute('data-main');
                const subs = paper.getAttribute('data-sub').split(',');

                const matchMain = (selectedMain === 'all' || main === selectedMain);
                const matchSub = (!selectedSub || selectedSub === 'all' || subs.includes(selectedSub));

                paper.style.display = (matchMain && matchSub) ? '' : 'none';
            });
        }
    </script>
    <script>
        (function () {
            const KEY = (id) => `rtldr.paperVisibility.${id}`; // 'open' | 'closed'

            // SVGs for eye open/closed
            const eyeOpenSVG = `
    <svg class="vis-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" fill="none" stroke="currentColor" stroke-width="1.8"/>
      <circle cx="12" cy="12" r="3.5" fill="none" stroke="currentColor" stroke-width="1.8"/>
    </svg>`;
            const eyeClosedSVG = `
    <svg class="vis-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.8"/>
      <path d="M1 12s4-7 11-7a10.9 10.9 0 0 1 8.1 3.4M22.9 12.3C21.5 14.2 17.9 19 12 19c-7 0-11-7-11-7" fill="none" stroke="currentColor" stroke-width="1.8"/>
      <circle cx="12" cy="12" r="3.5" fill="none" stroke="currentColor" stroke-width="1.8"/>
    </svg>`;

            function ensureTitleRowAndBody(paperEl) {
                // Find the row with <h2> (your markup already has the first <div> with h2 + bookmark)
                const firstDiv = paperEl.querySelector('div');
                if (firstDiv && !firstDiv.classList.contains('title-row')) {
                    firstDiv.classList.add('title-row');
                }
                // Wrap everything after title row into .paper-body, if not already
                if (!paperEl.querySelector('.paper-body')) {
                    const body = document.createElement('div');
                    body.className = 'paper-body';
                    // Move siblings after title-row into body
                    let node = firstDiv?.nextSibling;
                    const toMove = [];
                    while (node) {
                        const next = node.nextSibling;
                        toMove.push(node);
                        node = next;
                    }
                    toMove.forEach(n => body.appendChild(n));
                    paperEl.appendChild(body);
                }
            }

            function addVisibilityButton(paperEl) {
                const id = paperEl.dataset.paperId || paperEl.querySelector('.meta')?.dataset.paperId || '';
                if (!id) return;
                const titleRow = paperEl.querySelector('.title-row');
                if (!titleRow || titleRow.querySelector('.visibility-toggle')) return;

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'visibility-toggle';
                btn.setAttribute('aria-label', 'Toggle visibility');
                btn.setAttribute('aria-pressed', 'false');

                // Insert after the title <h2> (before bookmark), or just append
                const h2 = titleRow.querySelector('h2');
                if (h2 && h2.nextSibling) titleRow.insertBefore(btn, h2.nextSibling);
                else titleRow.appendChild(btn);

                // Initial state
                const saved = localStorage.getItem(KEY(id)) || 'open';
                applyState(paperEl, btn, saved === 'open');

                // Click to toggle
                btn.addEventListener('click', () => {
                    const isOpen = !paperEl.classList.contains('collapsed');
                    applyState(paperEl, btn, !isOpen);
                    localStorage.setItem(KEY(id), (!isOpen) ? 'open' : 'closed');
                });
            }

            function applyState(paperEl, btn, open) {
                if (open) {
                    paperEl.classList.remove('collapsed');
                    btn.innerHTML = eyeOpenSVG;
                    btn.setAttribute('aria-pressed', 'true');
                    btn.title = 'Hide content';
                } else {
                    paperEl.classList.add('collapsed');
                    btn.innerHTML = eyeClosedSVG;
                    btn.setAttribute('aria-pressed', 'false');
                    btn.title = 'Show content';
                }
            }

            // Init on load
            window.addEventListener('load', () => {
                document.querySelectorAll('.paper').forEach(paperEl => {
                    ensureTitleRowAndBody(paperEl);
                    addVisibilityButton(paperEl);

                    // Restore saved state
                    const id = paperEl.dataset.paperId || paperEl.querySelector('.meta')?.dataset.paperId || '';
                    if (id) {
                        const saved = localStorage.getItem(KEY(id)) || 'open';
                        const btn = paperEl.querySelector('.visibility-toggle');
                        if (btn) applyState(paperEl, btn, saved === 'open');
                    }
                });
            });
        })();
    </script>


    <!-- ===== ResearchTLDR: PDF Focus Mode w/ Icon Toggle ===== -->
    <style>
        :root {
            --rtldr-pdf-width: 48vw;
        }

        body.rtldr-pdf-open {
            overflow-y: auto;
        }

        body.rtldr-pdf-open #rtldr-pdf-panel {
            display: block;
        }

        #rtldr-pdf-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: var(--rtldr-pdf-width);
            max-width: 90vw;
            min-width: 280px;
            background: #111;
            color: #fff;
            border-left: 1px solid rgba(255, 255, 255, 0.15);
            display: none;
            z-index: 9999;
            box-shadow: -8px 0 24px rgba(0, 0, 0, 0.25);
        }

        #rtldr-pdf-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            user-select: none;
        }

        #rtldr-pdf-header .title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #rtldr-pdf-header button,
        #rtldr-pdf-header a {
            appearance: none;
            border: 0;
            background: #222;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
        }

        #rtldr-pdf-iframe {
            width: 100%;
            height: calc(100% - 46px);
            border: 0;
            background: #222;
        }

        #rtldr-pdf-resizer {
            position: absolute;
            left: -6px;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            background: transparent;
        }

        #rtldr-pdf-tip {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            opacity: 0.75;
        }

        @media (min-width: 980px) {
            body.rtldr-pdf-open {
                padding-right: var(--rtldr-pdf-width);
            }
        }

        .rtldr-toolbar {
            margin-top: 6px;
            font-size: 13px;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rtldr-toolbar a {
            color: inherit;
            text-decoration: underline;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .rtldr-sep {
            margin: 0 6px;
            opacity: .5;
        }

        .rtldr-icon {
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
        }

        .rtldr-focus-btn {
            appearance: none;
            border: 1px solid #d1d5db;
            background: #f8fafc;
            color: #111;
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 6px;
            margin-top: 8px;
            margin-bottom: 6px;
        }

        .rtldr-focus-btn:hover {
            background: #eef2f7;
        }

        .rtldr-focus-btn:focus {
            outline: 2px solid #ddd;
            outline-offset: 2px;
        }

        .title-row .bookmark-toggle {
            margin: 0;
            padding: 0;
            line-height: 0;
            display: inline-flex;
            align-items: center;
        }

        .title-row .bookmark-toggle svg {
            width: 20px;
            height: 20px;
        }
    </style>

    <div id="rtldr-pdf-panel" aria-hidden="true" role="dialog" aria-label="PDF Focus Panel">
        <div id="rtldr-pdf-resizer" title="Drag to resize"></div>
        <div id="rtldr-pdf-header">
            <div class="title" id="rtldr-pdf-title">PDF</div>
        </div>
        <iframe id="rtldr-pdf-iframe" src="about:blank" allow="fullscreen"></iframe>
        <div id="rtldr-pdf-tip">Use the Focus mode button in the paper to open/close. [ / ] resize. Drag the thin left
            edge to resize.</div>
    </div>

    <script>
        (function () {
            const LS_WIDTH = 'rtldr.pdf.width.v1';
            const doc = document;
            const panel = doc.getElementById('rtldr-pdf-panel');
            const iframe = doc.getElementById('rtldr-pdf-iframe');
            const titleEl = doc.getElementById('rtldr-pdf-title');
            const resizer = doc.getElementById('rtldr-pdf-resizer');

            let currentUrl = '';
            let currentPaper = null;

            function setWidth(px) {
                const vw = Math.max(280, Math.min(window.innerWidth * 0.9, px));
                const vwPercent = (vw / window.innerWidth) * 100;
                document.documentElement.style.setProperty('--rtldr-pdf-width', vwPercent + 'vw');
                try { localStorage.setItem(LS_WIDTH, String(vw)); } catch { }
            }
            try {
                const saved = parseFloat(localStorage.getItem(LS_WIDTH));
                if (Number.isFinite(saved) && saved > 0) setWidth(saved);
                else setWidth(window.innerWidth * 0.48);
            } catch { setWidth(window.innerWidth * 0.48); }

            function normalizePdfUrl(u) {
                try {
                    const abs = new URL(u, location.href).href;
                    return abs.replace(/^http:/i, 'https:');
                } catch {
                    return u;
                }
            }

            function show(url, title, paperEl) {
                if (!url) return;
                url = normalizePdfUrl(url);
                if (!/\.pdf(\?|$)/i.test(url) && !/arxiv\.org\/pdf\//i.test(url)) return;

                document.body.classList.add('rtldr-pdf-open');
                panel.style.display = 'block';
                panel.setAttribute('aria-hidden', 'false');

                if (currentUrl !== url) {
                    iframe.src = url;
                    currentUrl = url;
                }
                titleEl.textContent = title || 'PDF';

                // remove highlight from previous paper
                if (currentPaper) currentPaper.classList.remove('rtldr-focused-paper');
                // highlight the one we just clicked
                currentPaper = paperEl;
                if (currentPaper) currentPaper.classList.add('rtldr-focused-paper');

                updateAllFocusButtons();
            }


            function hide() {
                document.body.classList.remove('rtldr-pdf-open');
                panel.setAttribute('aria-hidden', 'true');
                panel.style.display = 'none';                 // keep if you like instant hide

                // clear highlight
                if (currentPaper) {
                    currentPaper.classList.remove('rtldr-focused-paper');
                    currentPaper = null;
                }

                updateAllFocusButtons();                      // <-- refresh button label
            }


            // Resizer
            let dragging = false, startX = 0, startW = 0;
            resizer.addEventListener('mousedown', (e) => { dragging = true; startX = e.clientX; startW = panel.getBoundingClientRect().width; doc.body.style.userSelect = 'none'; });
            window.addEventListener('mousemove', (e) => { if (!dragging) return; const dx = startX - e.clientX; setWidth(startW + dx); });
            window.addEventListener('mouseup', () => { dragging = false; doc.body.style.userSelect = ''; });

            // Keys
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hide();
                if (!doc.body.classList.contains('rtldr-pdf-open')) return;
                if (e.key === '[') { const w = panel.getBoundingClientRect().width; setWidth(w + Math.max(24, window.innerWidth * 0.02)); }
                if (e.key === ']') { const w = panel.getBoundingClientRect().width; setWidth(w - Math.max(24, window.innerWidth * 0.02)); }
            });

            // Build toolbar: arXiv Page | PDF | [icon]
            function toAbsFromPdf(pdfHref) {
                try {
                    const u = new URL(pdfHref, location.href);
                    if (/arxiv\.org\/pdf\//i.test(u.href)) {
                        const id = u.pathname.replace(/^\/pdf\//, '').replace(/\.pdf$/, '').replace(/^\/+/, '');
                        return u.origin + '/abs/' + id;
                    }
                } catch { }
                return null;
            }

            function ensureFocusButton(paper) {
                if (!paper || paper.querySelector('.rtldr-focus-btn')) return;

                const pdfLink = Array.from(paper.querySelectorAll('a[href]'))
                    .find(a => (a.getAttribute('href') || '').toLowerCase().endsWith('.pdf')
                        || /arxiv\.org\/pdf\//i.test(a.getAttribute('href') || ''));
                if (!pdfLink) return;

                const row = pdfLink.closest('p') || pdfLink.parentElement;
                const rawHref = pdfLink.getAttribute('href');
                const pdfHref = normalizePdfUrl(rawHref);          // ✅ normalize once
                const title = paper.querySelector('h2, h3, .title')?.textContent?.trim() || 'PDF';

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'rtldr-focus-btn';
                btn.dataset.pdfHref = pdfHref;                     // ✅ store normalized

                function updateLabel() {
                    const isOpen = document.body.classList.contains('rtldr-pdf-open');
                    btn.textContent = (isOpen && currentUrl === pdfHref) ? 'Hide focus mode' : 'Focus mode';
                }

                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const target = btn.dataset.pdfHref;              // already normalized
                    const isOpen = document.body.classList.contains('rtldr-pdf-open');

                    if (isOpen && currentUrl === target) {           // ✅ robust toggle
                        hide();
                    } else {
                        show(target, title, paper);
                    }
                });

                row.insertAdjacentElement('beforebegin', btn);
                updateLabel();
            }


            function updateAllFocusButtons() {
                const isOpen = document.body.classList.contains('rtldr-pdf-open');
                document.querySelectorAll('.rtldr-focus-btn').forEach(btn => {
                    const href = btn.dataset.pdfHref;               // already normalized
                    btn.textContent = (isOpen && currentUrl === href) ? 'Hide focus mode' : 'Focus mode';
                });
            }

            function enhanceAll() {
                const papers = document.querySelectorAll('.paper');
                if (papers.length) papers.forEach(ensureFocusButton);
                else {
                    const cards = Array.from(document.querySelectorAll('div, article, li'))
                        .filter(x => x.querySelector && x.querySelector('a[href$=".pdf"], a[href*="arxiv.org/pdf/"]'));
                    cards.forEach(ensureFocusButton);
                }
            }
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', enhanceAll);
            else enhanceAll();
        })();
    </script>
    <!-- ===== /PDF Focus Mode (icon toggle) ===== -->

</body>

</html>