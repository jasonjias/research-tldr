<!DOCTYPE html>
<html>

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ GA_MEASUREMENT_ID }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', '{{ GA_MEASUREMENT_ID }}');
    </script>

    <title>arXiv Papers</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    RR: "\\mathbb{R}",
                    VV: "\\mathbb{V}",
                    VVV: "\\mathcal{V}",
                    ZZ: "\\mathbb{Z}"
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
</head>


<body data-logged-in="{{ '1' if user else '' }}">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
        {% if user %}
        <img src="{{ user.picture }}" referrerpolicy="no-referrer" style="width:28px;height:28px;border-radius:50%">
        <span>Signed in as {{ user.name or user.email }}</span>
        <a href="/logout">Logout</a>
        {% else %}
        <a href="/login">Sign in with Google</a>
        {% endif %}
    </div>
    {% if user %}
    <nav class="view-switcher" style="margin: 12px 0;">
        <a href="/" class="{{ 'font-bold' if active_view != 'bookmarks' else '' }}">All papers</a>
        &nbsp;Â·&nbsp;
        <a href="/bookmarks" class="{{ 'font-bold' if active_view == 'bookmarks' else '' }}">My bookmarks</a>
    </nav>
    {% endif %}

    <h1>arXiv Papers</h1>
    <!-- Main Category Filters -->
    <div id="category-filters">
        <label for="main-category">Filter by Category:</label>
        <select id="main-category" onchange="filterByMainCategory()">
            <option value="all">All</option>
            <option value="math">Mathematics</option>
            <option value="cs">Computer Science</option>
            <option value="physics">Physics</option>
            <option value="stat">Statistics</option>
            <option value="q-bio">Quantitative Biology</option>
            <option value="q-fin">Quantitative Finance</option>
            <option value="eess">Electrical Engineering & Systems Science</option>
            <option value="econ">Economics</option>
        </select>
    </div>


    <div id="subcategory-filters" style="display: none;">
        <label for="sub-category">Filter by Subcategory:</label>
        <select id="sub-category" onchange="filterBySubCategory()">
            <option value="all">All</option>
        </select>
    </div>
    {% for paper in papers %}
    {% set primary = paper.categories | selectattr("is_primary") | list | first %}
    <div class="paper" data-main="{{ primary.term.split('.')[0] if primary else 'unknown' }}"
        data-sub="{{ paper.categories | map(attribute='term') | join(',') }}">

        <h2>{{ paper.title }}</h2>
        <p><strong>Published:</strong> {{ paper.published }}</p>
        <!-- <p><strong>Updated:</strong> {{ paper.updated }}</p> -->
        <p><strong>Authors:</strong> {{ paper.authors }}</p>

        {% if paper.categories %}
        <p><strong>Categories:</strong>
            {% for category in paper.categories %}
            {% if category.is_primary %}
            <span><strong>{{ category.term }}</strong></span>{% if not loop.last %}, {% endif %}
            {% else %}
            <span>{{ category.term }}</span>{% if not loop.last %}, {% endif %}
            {% endif %}
            {% endfor %}
        </p>
        {% endif %}

        <p><strong>Abstract:</strong><br>{{ paper.summary | safe }}</p>

        {% if paper.llm_summary %}
        <details style="margin-top:8px;">
            <summary>
                <strong>Summary</strong>
                ({{ paper.summary_model or 'N/A' }} â€” added
                {{ paper.summary_updated_at.strftime('%Y-%m-%d %H:%M UTC') if paper.summary_updated_at else 'unknown'
                }})
            </summary>

            <!-- We'll render nicely if llm_summary is JSON; otherwise we show it as-is -->
            <div class="llm-summary" data-json="{{ paper.llm_summary | e }}"
                style="margin-top:6px; white-space:normal;"></div>
            <pre class="llm-summary-fallback" style="white-space:pre-wrap; margin-top:6px; display:none;">
            {{ paper.llm_summary }}
            </pre>
        </details>
        {% endif %}
        <p>
            <a href="{{ paper.url }}">arXiv Page</a> |
            <a href="{{ paper.pdf_url }}">PDF</a>
        </p>
        <!-- inside each paper card row (replace previous meta block) -->
        <div class="meta" data-paper-id="{{ paper.id }}">
            <span class="score">Score: <strong class="score-num">0</strong></span>
            <button class="vote-up" title="Upvote">â–²</button>
            <button class="vote-down" title="Downvote">â–¼</button>

            {% if user %}
            <button class="bookmark-btn" data-paper-id="{{ paper.id }}">ðŸ”– Bookmark</button>
            <span class="bookmarks">
                Bookmarks: <strong class="bookmarks-num" data-paper-id="{{ paper.id }}">â€”</strong>
            </span>
            {% else %}
            <button class="bookmark-btn" data-paper-id="{{ paper.id }}">ðŸ”– Bookmark</button>
            {% endif %}


        </div>
        <hr>
    </div>
    <!-- <hr> -->
    {% endfor %}

    <script>
        window.addEventListener("load", () => {
            if (window.MathJax) {
                MathJax.typeset();
            }
        });
    </script>
    <script>
        function filterByMainCategory() {
            const selected = document.getElementById('main-category').value;
            const papers = document.querySelectorAll('.paper');

            papers.forEach(paper => {
                const mainCategory = paper.getAttribute('data-main');
                if (selected === 'all' || mainCategory === selected) {
                    paper.style.display = '';
                } else {
                    paper.style.display = 'none';
                }
            });
        }
    </script>
    <script>
        const subcategoryMap = {};

        document.addEventListener("DOMContentLoaded", () => {
            const papers = document.querySelectorAll('.paper');

            // Build subcategory map
            papers.forEach(paper => {
                const main = paper.getAttribute('data-main');
                const subs = paper.getAttribute('data-sub').split(',');

                if (!subcategoryMap[main]) {
                    subcategoryMap[main] = new Set();
                }

                subs.forEach(sub => {
                    if (sub.startsWith(main)) {
                        subcategoryMap[main].add(sub);
                    }
                });
            });
        });

        function filterByMainCategory() {
            const selectedMain = document.getElementById('main-category').value;
            const subFilterDiv = document.getElementById('subcategory-filters');
            const subSelect = document.getElementById('sub-category');

            // Update subcategory dropdown
            if (selectedMain === 'all') {
                subFilterDiv.style.display = 'none';
            } else {
                subFilterDiv.style.display = 'block';
                subSelect.innerHTML = '<option value="all">All</option>';

                const subs = Array.from(subcategoryMap[selectedMain] || []).sort();
                for (const sub of subs) {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subSelect.appendChild(option);
                }
            }

            filterPapers();
        }

        function filterBySubCategory() {
            filterPapers();
        }

        function filterPapers() {
            const selectedMain = document.getElementById('main-category').value;
            const selectedSub = document.getElementById('sub-category').value;
            const papers = document.querySelectorAll('.paper');

            papers.forEach(paper => {
                const main = paper.getAttribute('data-main');
                const subs = paper.getAttribute('data-sub').split(',');

                const matchMain = (selectedMain === 'all' || main === selectedMain);
                const matchSub = (selectedSub === 'all' || subs.includes(selectedSub));

                if (matchMain && matchSub) {
                    paper.style.display = '';
                } else {
                    paper.style.display = 'none';
                }
            });
        }
    </script>
    <script>
        // ---------- GA helper ----------
        function trackEvent(name, params) {
            if (window.gtag) window.gtag('event', name, params || {});
        }

        // After login: fire event and clean URL
        (() => {
            const p = new URLSearchParams(location.search);
            if (p.has('login_success')) {
                trackEvent('login', { method: 'google' });
                history.replaceState(null, '', location.pathname);
            }
        })();
    </script>

    <script>
        // ---------- Paper clicks (arXiv/PDF) ----------
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;

            const url = link.getAttribute('href') || '';
            const isPDF = url.toLowerCase().endsWith('.pdf');
            const isArxiv = /arxiv\.org/.test(url);

            if (isPDF || isArxiv) {
                const paperEl = link.closest('.paper');
                const title = paperEl?.querySelector('h2')?.textContent?.trim();
                // Try to derive an arXiv ID if present in the URL
                const idMatch = url.match(/arxiv\.org\/(?:abs|pdf)\/([^\s\/?#]+)/i);
                const paperId = idMatch ? idMatch[1].replace(/\.pdf$/i, '') : undefined;

                trackEvent('paper_open', {
                    type: isPDF ? 'pdf' : 'arxiv',
                    paper_id: paperId,
                    paper_title: title
                });
            }
        });
    </script>

    <script>
        // ---------- Filter changes ----------
        const mainSelect = document.getElementById('main-category');
        const subSelect = document.getElementById('sub-category');

        if (mainSelect) {
            mainSelect.addEventListener('change', () => {
                trackEvent('filter_change', { filter: 'main_category', value: mainSelect.value });
            });
        }
        if (subSelect) {
            subSelect.addEventListener('change', () => {
                trackEvent('filter_change', {
                    filter: 'sub_category',
                    value: subSelect.value,
                    main_category: mainSelect ? mainSelect.value : undefined
                });
            });
        }
    </script>

    <script>
        // ---------- Paper impressions on load (counts by main category) ----------
        window.addEventListener('load', () => {
            const counts = {};
            document.querySelectorAll('.paper').forEach(p => {
                const main = p.getAttribute('data-main') || 'unknown';
                counts[main] = (counts[main] || 0) + 1;
            });
            trackEvent('paper_impressions', counts);
        });
    </script>
    <script>
        (function () {
            const loggedIn = !!document.body.dataset.loggedIn;

            async function getJSON(url, opts = {}) {
                const r = await fetch(url, { credentials: 'same-origin', ...opts });
                let text = await r.text();
                let data;
                try { data = text ? JSON.parse(text) : null; } catch { data = { detail: text }; }
                if (!r.ok) {
                    const err = new Error((data && (data.detail || data.message)) || 'Request failed');
                    err.status = r.status;
                    err.body = data;
                    throw err;
                }
                return data;
            }

            async function hydratePublicCounts() {
                for (const m of document.querySelectorAll('.meta')) {
                    const id = m.dataset.paperId;
                    getJSON(`/api/papers/${id}/score`).then(d => {
                        m.querySelector('.score-num').textContent = d.score;
                    }).catch(() => { });

                    // If not logged in, you can skip fetching bookmark counts if desired
                    if (loggedIn) {
                        getJSON(`/api/papers/${id}/bookmarks`).then(d => {
                            m.querySelector('.bookmarks-num').textContent = d.count;
                        }).catch(() => { });
                    } else {
                        // Hide or clear bookmark count for logged-out users
                        m.querySelector('.bookmarks-num').textContent = '';
                    }
                }
            }

            document.addEventListener('click', async (e) => {
                const row = e.target.closest('.meta');
                if (!row) return;
                const id = row.dataset.paperId;

                // Votes
                if (e.target.closest('.vote-up') || e.target.closest('.vote-down')) {
                    const upBtn = row.querySelector('.vote-up');
                    const downBtn = row.querySelector('.vote-down');
                    const currentScoreEl = row.querySelector('.score-num');

                    // Read current state from a data attribute (or class)
                    const currentVote = row.dataset.myVote ? parseInt(row.dataset.myVote) : 0;

                    let newValue;
                    if (e.target.closest('.vote-up')) {
                        newValue = currentVote === 1 ? 0 : 1;   // clear if already upvoted
                    } else {
                        newValue = currentVote === -1 ? 0 : -1; // clear if already downvoted
                    }

                    try {
                        const d = await getJSON(`/api/papers/${id}/vote`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: newValue }),
                            credentials: 'same-origin'
                        });
                        currentScoreEl.textContent = d.score;
                        row.dataset.myVote = newValue; // store new state
                    } catch {
                        if (confirm('Please sign in to vote. Go to login?')) location.href = '/login';
                    }
                    return;
                }

                // Bookmarks
                if (e.target.closest('.bookmark-btn')) {
                    if (!loggedIn) {
                        // Redirect to login if not signed in
                        location.href = '/login';
                        return;
                    }
                    const btn = e.target.closest('.bookmark-btn');
                    const isBookmarked = btn.textContent.includes('âœ…');
                    try {
                        if (isBookmarked) {
                            await getJSON(`/api/papers/${id}/bookmark`, { method: 'DELETE' });
                        } else {
                            await getJSON(`/api/papers/${id}/bookmark`, { method: 'POST' });
                        }
                        const d = await getJSON(`/api/papers/${id}/bookmarks`);
                        row.querySelector('.bookmarks-num').textContent = d.count;
                        btn.textContent = isBookmarked ? 'ðŸ”– Bookmark' : 'âœ… Bookmarked';
                    } catch {
                        if (confirm('Please sign in to bookmark papers. Go to login?')) location.href = '/login';
                    }
                }
            });

            window.addEventListener('load', async () => {
                await hydratePublicCounts();
            });
        })();
    </script>
    <script>
        (function () {
            // Remove leading bullet/numbering like "â€¢ ", "- ", "â€” ", "* ", "1. ", "2) ", etc.
            function cleanItemText(s) {
                if (!s) return "";
                s = String(s);
                // Strip common bullet characters and numeric prefixes
                s = s.replace(/^\s*([â€¢\-\u2013\u2014\*]|\d+[\.\)])\s+/, ""); // â€¢ - â€“ â€” * or 1. / 2)
                // Also collapse accidental double bullets inside the text
                s = s.replace(/^\s*â€¢\s*/, "");
                return s.trim();
            }
            const esc = (t) => String(t || "").replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
            const ul = (arr) => (arr && arr.length)
                ? `<ul style="margin:6px 0 12px 1.25em; list-style:disc; list-style-position:outside;">${arr.map(x => `<li>${esc(cleanItemText(x))}</li>`).join('')
                }</ul>`
                : '';

            function renderSummary(json) {
                let html = "";
                if (json.tldr) {
                    html += `<h4 style="margin:8px 0 4px;">TL;DR</h4><p style="margin:0 0 10px;">${esc(json.tldr)}</p>`;
                }
                if (json.whats_new && json.whats_new.length) {
                    html += `<h4 style="margin:8px 0 4px;">Whatâ€™s new</h4>${ul(json.whats_new)}`;
                }
                if (json.method) {
                    html += `<h4 style="margin:8px 0 4px;">Method (plain English)</h4><p style="margin:0 0 10px;">${esc(json.method)}</p>`;
                }
                if (json.results && json.results.length) {
                    html += `<h4 style="margin:8px 0 4px;">Results</h4>${ul(json.results)}`;
                }
                if (json.limitations && json.limitations.length) {
                    html += `<h4 style="margin:8px 0 4px;">Limitations</h4>${ul(json.limitations)}`;
                }
                if (json.why_useful) {
                    html += `<h4 style="margin:8px 0 4px;">Why itâ€™s useful</h4><p style="margin:0 0 10px;">${esc(json.why_useful)}</p>`;
                }
                const prov = json.provenance || {};
                const bits = [];
                if (prov.code_data_availability) bits.push(`Code/Data: ${esc(prov.code_data_availability)}`);
                if (Array.isArray(prov.page_citations) && prov.page_citations.length) {
                    bits.push(`Citations: ${esc(prov.page_citations.join(', '))}`);
                }
                if (bits.length) html += `<div style="margin-top:8px; font-size:0.95em; opacity:0.85;">${bits.join(' â€¢ ')}</div>`;
                return html || null;
            }

            document.querySelectorAll('.llm-summary').forEach(node => {
                const raw = node.getAttribute('data-json') || '';
                if (!raw.trim().startsWith('{')) {
                    node.style.display = 'none';
                    const pre = node.parentElement.querySelector('.llm-summary-fallback');
                    if (pre) pre.style.display = '';
                    return;
                }
                try {
                    const json = JSON.parse(raw);
                    const html = renderSummary(json);
                    if (html) {
                        node.innerHTML = html;
                        const pre = node.parentElement.querySelector('.llm-summary-fallback');
                        if (pre) pre.style.display = 'none';
                    } else {
                        node.style.display = 'none';
                        const pre = node.parentElement.querySelector('.llm-summary-fallback');
                        if (pre) pre.style.display = '';
                    }
                } catch {
                    node.style.display = 'none';
                    const pre = node.parentElement.querySelector('.llm-summary-fallback');
                    if (pre) pre.style.display = '';
                }
            });
        })();
    </script>


</body>

</html>